<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Aptitude Labs</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #2563EB; --primary-hover: #1D4ED8; --bg-body: #F3F4F6; --bg-card: #FFFFFF; --text-main: #111827; --text-muted: #6B7280; --border: #E5E7EB; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; }

        .navbar { background: white; height: 64px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .beta-tag { background: #DBEAFE; color: var(--primary); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .btn-logout { background: none; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); transition: all 0.2s; }
        .btn-logout:hover { background: #F9FAFB; border-color: #9CA3AF; color: var(--text-main); }

        .container { max-width: 1200px; margin: 30px auto; display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px; padding: 0 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h2 { font-size: 1.5rem; letter-spacing: -0.5px; }
        .filter-tabs { display: flex; background: white; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .tab { background: none; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem; color: var(--text-muted); transition: 0.2s; }
        .tab.active { background: var(--bg-body); color: var(--text-main); }

        .mock-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
        .mock-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-color: var(--primary); }
        .mock-info h4 { font-size: 1.1rem; margin-bottom: 8px; font-weight: 600; }
        .mock-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted); }
        .badge { display: inline-block; margin-bottom: 6px; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge.free { background: #D1FAE5; color: #065F46; }
        .badge.premium { background: #FEF3C7; color: #92400E; }

        .btn-start { background: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-start:hover { background: var(--primary-hover); }
        .btn-lock { background: white; color: var(--text-main); border: 1px solid var(--border); padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card h3 { font-size: 0.85rem; margin-bottom: 15px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .stats-grid { display: flex; justify-content: space-between; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); }
        .leaderboard-list { list-style: none; }
        .leaderboard-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .leaderboard-row:last-child { border-bottom: none; }
        .rank { font-weight: 700; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.8rem; }
        .rank-1 { background: #FEF3C7; color: #92400E; }
        .rank-2 { background: #E5E7EB; color: #374151; }
        .rank-3 { background: #FFEDD5; color: #9A3412; }
        .name { flex: 1; margin-left: 10px; font-weight: 500; }
        .score { font-weight: 700; color: var(--primary); }
        .premium-banner { background: linear-gradient(135deg, #1E40AF, #3B82F6); color: white; padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2); }
        .premium-banner button { background: white; color: #1E40AF; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; transition: transform 0.1s; }
        .loading-skeleton { height: 80px; background: #E5E7EB; border-radius: 12px; margin-bottom: 15px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 0.3; } 100% { opacity: 0.6; } }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } .navbar { padding: 0 20px; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo"><i class="material-icons" style="color:var(--primary);">school</i> Aptitude Labs <span class="beta-tag">BETA</span></div>
        <div class="nav-right">
            <span id="user-greeting">Welcome</span>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <main class="main-content">
            <div class="section-header">
                <h2>My Test Series</h2>
                <div class="filter-tabs">
                    <button class="tab active" onclick="filterMocks('all')">All</button>
                    <button class="tab" onclick="filterMocks('full')">Full Mocks</button>
                    <button class="tab" onclick="filterMocks('sectional')">Sectional</button>
                </div>
            </div>
            <div class="mock-list" id="mock-list">
                <div class="loading-skeleton"></div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="card stats-card">
                <h3>Your Progress</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span class="stat-val" id="tests-taken">0</span><span class="stat-label">Tests Taken</span></div>
                    <div class="stat-item"><span class="stat-val" id="avg-score">--</span><span class="stat-label">Avg. Score</span></div>
                </div>
            </div>
            <div class="card leaderboard-card">
                <h3>üèÜ Toppers</h3>
                <ul class="leaderboard-list" id="leaderboard-list"><li style="padding:10px; text-align:center; color:#888;">Loading...</li></ul>
            </div>
            <div class="premium-banner">
                <h4>Unlock Premium</h4>
                <p style="font-size:0.85rem; margin-bottom:15px; opacity:0.9;">15 Full Mocks + Analysis</p>
                <button onclick="unlockPremium()">Upgrade for ‚Çπ99</button>
            </div>
        </aside>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBTbfSlz0xvfBzAWmJzXDGbIC6Up0-6eU4", authDomain: "aptitudelabs-in.firebaseapp.com", projectId: "aptitudelabs-in", storageBucket: "aptitudelabs-in.firebasestorage.app", messagingSenderId: "175469863880", appId: "1:175469863880:web:b7b25ed27120665af716fd" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const mocks = [
            { id: 101, title: "IPMAT Indore 2024 (Official Replica)", type: "Free", qCount: 90, time: "120 min", category: "full" },
            { id: 102, title: "JIPMAT Full Length Mock 01", type: "Premium", qCount: 100, time: "150 min", category: "full" },
            { id: 103, title: "IPMAT Rohtak Speed Test 01", type: "Premium", qCount: 120, time: "120 min", category: "full" },
            { id: 104, title: "Quantitative Ability (SA) - Algebra", type: "Free", qCount: 20, time: "40 min", category: "sectional" }
        ];

        window.onload = function() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    const username = user.email.split('@')[0];
                    document.getElementById('user-greeting').innerHTML = `Hello, <span style="color:var(--primary); font-weight:bold;">${username}</span>`;
                    loadDashboardData();
                } else {
                    window.location.href = "login.html";
                }
            });
        };

        function loadDashboardData() { renderMockList(mocks); fetchLeaderboard(); }

        function renderMockList(data) {
            const container = document.getElementById('mock-list');
            container.innerHTML = '';
            data.forEach(mock => {
                const isFree = mock.type === "Free";
                const isUnlocked = localStorage.getItem("premium_unlocked") === "true";
                let btnHTML = (isFree || isUnlocked) 
                    ? `<button class="btn-start" onclick="startTest(${mock.id})">Attempt Now</button>` 
                    : `<button class="btn-lock" onclick="unlockPremium()"><i class="material-icons">lock</i> Unlock</button>`;
                
                const badgeClass = (isFree || isUnlocked) ? 'free' : 'premium';
                const badgeText = (isFree || isUnlocked) ? "Available" : "Premium";

                container.innerHTML += `
                    <div class="mock-card">
                        <div class="mock-info">
                            <span class="badge ${badgeClass}">${badgeText}</span>
                            <h4>${mock.title}</h4>
                            <div class="mock-meta"><span>${mock.qCount} Qs</span><span>${mock.time}</span></div>
                        </div>
                        <div class="mock-action">${btnHTML}</div>
                    </div>`;
            });
        }

        function fetchLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            db.collection('testResults').orderBy('score', 'desc').limit(5).get().then((querySnapshot) => {
                list.innerHTML = '';
                if(querySnapshot.empty) { list.innerHTML = '<li style="padding:10px; text-align:center;">No results yet.</li>'; return; }
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let name = data.studentName || data.email || "Anonymous";
                    if(name.includes('@')) name = name.split('@')[0];
                    let rankClass = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : ''));
                    list.innerHTML += `<li class="leaderboard-row"><span class="rank ${rankClass}">${rank}</span><span class="name">${name}</span><span class="score">${data.score}</span></li>`;
                    rank++;
                });
            });
        }

        window.startTest = function(testId) {
            localStorage.setItem("currentTestId", testId);
            // CRITICAL CHANGE: Now redirects to exam.html instead of index.html
            window.location.href = "exam.html";
        }

        window.unlockPremium = function() {
            if(confirm("Unlock Full Access for ‚Çπ99?")) { localStorage.setItem("premium_unlocked", "true"); location.reload(); }
        }

        window.logout = function() { auth.signOut().then(() => { window.location.href = "login.html"; }); }
    </script>
</body>
</html>