<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Console | Aptitude Labs</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #2563EB; --bg: #F3F4F6; --border: #E5E7EB; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: white; padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        header h2 { margin: 0; font-size: 1.2rem; color: #111827; }
        .status-bar { font-size: 0.9rem; color: #666; }

        /* MAIN LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* LEFT: SETTINGS & PALETTE */
        .sidebar { width: 300px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .config-box { padding: 20px; border-bottom: 1px solid var(--border); background: #f9fafb; }
        .config-box label { display: block; font-size: 0.8rem; font-weight: 700; color: #4B5563; margin-bottom: 5px; }
        .config-box input, .config-box select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 10px; }
        
        /* NEW: PUBLISH CONTROL */
        .publish-box { 
            background: white; border: 1px solid #ddd; padding: 10px; border-radius: 6px; 
            margin-top: 10px; text-align: center; 
        }
        .status-indicator { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
        .is-live { background: #D1FAE5; color: #065F46; border: 1px solid #A7F3D0; }
        .is-locked { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
        
        .btn-toggle { width: 100%; padding: 6px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #f0f0f0; }
        .btn-toggle:hover { background: #e5e5e5; }

        /* PALETTE GRID */
        .q-list-header { padding: 10px 20px; background: #e5e7eb; font-weight: bold; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .q-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; align-content: start; }
        
        .q-btn { 
            aspect-ratio: 1; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .q-btn:hover { border-color: var(--primary); color: var(--primary); }
        .q-btn.exists { background: #D1FAE5; color: #065F46; border-color: #A7F3D0; } 
        .q-btn.active { border: 2px solid var(--primary); font-weight: bold; transform: scale(1.1); }

        /* RIGHT: EDITOR */
        .editor { flex: 1; padding: 30px; overflow-y: auto; max-width: 900px; margin: 0 auto; }
        .editor-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .section-info { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9rem; font-weight: 600; display: flex; justify-content: space-between; }

        .row { display: flex; gap: 20px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; color: #374151; }
        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem;
        }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid #E5E7EB; margin-bottom: 15px; }
        .opt-row { display: flex; align-items: center; }
        .opt-row input[type="radio"] { margin-right: 10px; transform: scale(1.2); cursor: pointer; }

        .toolbar { margin-top: 20px; display: flex; gap: 15px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn { padding: 10px 24px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 1rem; }
        .btn-save { background: var(--primary); color: white; flex: 1; }
        .btn-save:hover { background: #1D4ED8; }
        .btn-new { background: #fff; border: 1px solid #ccc; color: #333; }
        
        .badge { padding: 2px 6px; background: #eee; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <h2>Teacher's Console <span class="badge">Smart Editor</span></h2>
        <div class="status-bar">Admin: <span id="admin-id">...</span></div>
    </header>

    <div class="workspace">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="config-box">
                <label>1. Select Exam Pattern</label>
                <select id="exam-cat" onchange="updateMockConfig()">
                    <option value="INDORE">IPMAT Indore (Fixed)</option>
                    <option value="ROHTAK">IPMAT Rohtak</option>
                    <option value="JIPMAT">JIPMAT</option>
                </select>
                
                <label>2. Mock Number</label>
                <input type="number" id="mock-num" value="1" min="1" max="50" oninput="updateMockConfig()">
                
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">
                    Active ID: <strong id="active-mock-id" style="color:var(--primary);">INDORE-MOCK-01</strong>
                </div>

                <!-- PUBLISH CONTROLS -->
                <div class="publish-box">
                    <span id="status-badge" class="status-indicator is-locked">ðŸ”´ LOCKED</span>
                    <button class="btn-toggle" onclick="toggleLiveStatus()">Toggle Status</button>
                </div>

                <button onclick="loadQuestionsList()" style="width:100%; margin-top:10px; padding:8px; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">ðŸ”„ Refresh Grid</button>
            </div>

            <div class="q-list-header">
                <span>Question Grid</span>
                <span id="q-count">0/0</span>
            </div>
            <div class="q-grid" id="q-grid">
                <!-- Grid items will be injected here -->
            </div>
        </div>

        <!-- EDITOR -->
        <div class="editor">
            <div class="editor-card">
                <!-- Smart Section Indicator -->
                <div class="section-info" id="section-info-bar">
                    <span id="current-sec-name">QA (Short Answer)</span>
                    <span id="current-sec-range">Range: Q1 - Q15</span>
                </div>

                <form id="editor-form">
                    <input type="hidden" id="doc-id">

                    <div class="row">
                        <div class="col" style="flex:0.3;">
                            <label>Q. No <span style="color:red">*</span></label>
                            <input type="number" id="q-number" placeholder="1" required oninput="checkPatternRules()">
                        </div>
                        <div class="col">
                            <label>Section (Auto-Detected)</label>
                            <input type="text" id="section" readonly style="background:#f0f0f0; color:#555;">
                        </div>
                        <div class="col" style="flex:0.4;">
                            <label>Type (Auto)</label>
                            <select id="q-type" onchange="toggleFields()" disabled style="background:#f0f0f0; color:#555;">
                                <option value="MCQ">MCQ</option>
                                <option value="SA">Short Answer</option>
                                <option value="RC">RC Passage</option>
                            </select>
                        </div>
                    </div>

                    <div id="passage-box" class="hidden">
                        <label>Reading Comprehension Passage / DI Data:</label>
                        <textarea id="passage-text" style="height:150px;" placeholder="Paste passage here..."></textarea>
                    </div>

                    <label>Question Text <span style="color:red">*</span></label>
                    <textarea id="q-text" required placeholder="Type the question here..."></textarea>

                    <div id="options-box">
                        <label>Options & Correct Answer:</label>
                        <div class="options-grid">
                            <div class="opt-row"><input type="radio" name="correct" value="A"> <input type="text" id="opt-a" placeholder="Option A"></div>
                            <div class="opt-row"><input type="radio" name="correct" value="B"> <input type="text" id="opt-b" placeholder="Option B"></div>
                            <div class="opt-row"><input type="radio" name="correct" value="C"> <input type="text" id="opt-c" placeholder="Option C"></div>
                            <div class="opt-row"><input type="radio" name="correct" value="D"> <input type="text" id="opt-d" placeholder="Option D"></div>
                        </div>
                    </div>

                    <div id="sa-box" class="hidden">
                        <label>Correct Numerical Answer:</label>
                        <input type="text" id="sa-val" placeholder="e.g. 24">
                    </div>

                    <label>Detailed Solution (Explanation):</label>
                    <textarea id="solution-text" placeholder="Step-by-step solution..."></textarea>

                    <div class="toolbar">
                        <button type="button" class="btn btn-new" onclick="prepareNewEntry()">Clear / Next</button>
                        <button type="submit" class="btn btn-save" id="save-btn">Save Question</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const ADMIN_EMAIL = "your.admin.email@example.com"; // UPDATE THIS!
        
        const firebaseConfig = { apiKey: "AIzaSyBTbfSlz0xvfBzAWmJzXDGbIC6Up0-6eU4", authDomain: "aptitudelabs-in.firebaseapp.com", projectId: "aptitudelabs-in", storageBucket: "aptitudelabs-in.firebasestorage.app", messagingSenderId: "175469863880", appId: "1:175469863880:web:b7b25ed27120665af716fd" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- EXAM RULES ENGINE ---
        const EXAM_RULES = {
            "INDORE": [
                { name: "QA (Short Answer)", type: "SA", start: 1, end: 15 },
                { name: "QA (MCQ)", type: "MCQ", start: 16, end: 45 },
                { name: "Verbal Ability", type: "MCQ", start: 46, end: 90 }
            ],
            "ROHTAK": [
                { name: "Quantitative Ability", type: "MCQ", start: 1, end: 40 },
                { name: "Logical Reasoning", type: "MCQ", start: 41, end: 80 },
                { name: "Verbal Ability", type: "MCQ", start: 81, end: 120 }
            ],
            "JIPMAT": [
                { name: "Quantitative Aptitude", type: "MCQ", start: 1, end: 33 },
                { name: "DILR", type: "MCQ", start: 34, end: 66 },
                { name: "Verbal Ability", type: "MCQ", start: 67, end: 100 }
            ]
        };

        let currentQuestions = {}; 
        let isCurrentMockLive = false;

        auth.onAuthStateChanged(user => {
            if(user && user.email === ADMIN_EMAIL) {
                document.getElementById('admin-id').innerText = user.email;
                updateMockConfig();
            } else {
                window.location.href = "login.html";
            }
        });

        // --- UI & LOGIC ---
        function updateMockConfig() {
            const cat = document.getElementById('exam-cat').value;
            const num = document.getElementById('mock-num').value.padStart(2, '0');
            document.getElementById('active-mock-id').innerText = `${cat}-MOCK-${num}`;
            
            checkPatternRules(1); 
            checkLiveStatus(); // NEW: Check if live
            loadQuestionsList();
        }

        // --- PUBLISH LOGIC ---
        async function checkLiveStatus() {
            const mockId = document.getElementById('active-mock-id').innerText;
            const badge = document.getElementById('status-badge');
            
            try {
                const doc = await db.collection('exam_status').doc(mockId).get();
                if(doc.exists && doc.data().active) {
                    isCurrentMockLive = true;
                    badge.innerText = "ðŸŸ¢ LIVE";
                    badge.className = "status-indicator is-live";
                } else {
                    isCurrentMockLive = false;
                    badge.innerText = "ðŸ”´ LOCKED";
                    badge.className = "status-indicator is-locked";
                }
            } catch(e) { console.error(e); }
        }

        async function toggleLiveStatus() {
            const mockId = document.getElementById('active-mock-id').innerText;
            const newState = !isCurrentMockLive;
            
            if(confirm(`Are you sure you want to make ${mockId} ${newState ? 'LIVE' : 'LOCKED'}?`)) {
                await db.collection('exam_status').doc(mockId).set({
                    active: newState,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                checkLiveStatus(); // Refresh UI
            }
        }

        // --- CORE: PATTERN ENFORCEMENT ---
        function checkPatternRules(forceNum) {
            const cat = document.getElementById('exam-cat').value;
            const rules = EXAM_RULES[cat];
            let qNum = forceNum || parseInt(document.getElementById('q-number').value) || 1;

            const activeRule = rules.find(r => qNum >= r.start && qNum <= r.end);

            if (activeRule) {
                document.getElementById('section').value = activeRule.name;
                document.getElementById('q-type').value = activeRule.type;
                document.getElementById('current-sec-name').innerText = activeRule.name;
                document.getElementById('current-sec-range').innerText = `Range: Q${activeRule.start} - Q${activeRule.end}`;
                document.getElementById('section-info-bar').style.background = "#EFF6FF"; 
            } else {
                document.getElementById('section').value = "Out of Range";
                document.getElementById('section-info-bar').style.background = "#FEE2E2"; 
            }
            toggleFields();
        }

        window.toggleFields = () => {
            const type = document.getElementById('q-type').value;
            document.getElementById('passage-box').style.display = type === 'RC' ? 'block' : 'none';
            document.getElementById('options-box').style.display = type === 'SA' ? 'none' : 'block';
            document.getElementById('sa-box').style.display = type === 'SA' ? 'block' : 'none';
        }

        // --- PALETTE LOADER ---
        async function loadQuestionsList() {
            const mockId = document.getElementById('active-mock-id').innerText;
            const cat = document.getElementById('exam-cat').value;
            const totalQ = EXAM_RULES[cat][EXAM_RULES[cat].length-1].end;
            
            const grid = document.getElementById('q-grid');
            grid.innerHTML = 'Loading...';
            currentQuestions = {};

            try {
                const snapshot = await db.collection('questions').where('mockId', '==', mockId).get();
                grid.innerHTML = '';
                document.getElementById('q-count').innerText = `${snapshot.size}/${totalQ}`;

                for(let i=1; i<=totalQ; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'q-btn';
                    btn.innerText = i;
                    btn.id = `btn-q-${i}`;
                    btn.onclick = () => loadQuestionForEdit(i);
                    grid.appendChild(btn);
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.qNumber) {
                        currentQuestions[data.qNumber] = { id: doc.id, ...data };
                        const btn = document.getElementById(`btn-q-${data.qNumber}`);
                        if(btn) btn.classList.add('exists');
                    }
                });
            } catch (e) { console.error(e); }
        }

        // --- EDITING ---
        function loadQuestionForEdit(qNum) {
            resetForm();
            document.getElementById('q-number').value = qNum;
            checkPatternRules(qNum);

            const data = currentQuestions[qNum];
            if (data) {
                document.getElementById('doc-id').value = data.id;
                document.getElementById('q-text').value = data.text;
                document.getElementById('solution-text').value = data.solution || "";
                
                if(data.type === 'RC') document.getElementById('passage-text').value = data.passage || "";
                if(data.type === 'SA') {
                    document.getElementById('sa-val').value = data.correct;
                } else {
                    document.getElementById('opt-a').value = data.options[0] || "";
                    document.getElementById('opt-b').value = data.options[1] || "";
                    document.getElementById('opt-c').value = data.options[2] || "";
                    document.getElementById('opt-d').value = data.options[3] || "";
                    
                    const idx = data.options.indexOf(data.correct);
                    if(idx > -1) document.querySelectorAll('input[name="correct"]')[idx].checked = true;
                }
                
                document.getElementById('save-btn').innerText = "Update Question";
            }
        }

        function resetForm() {
            document.getElementById('editor-form').reset();
            document.getElementById('doc-id').value = "";
            document.getElementById('save-btn').innerText = "Save Question";
        }
        
        function prepareNewEntry() {
            const currentQ = parseInt(document.getElementById('q-number').value);
            resetForm();
            document.getElementById('q-number').value = currentQ + 1; 
            checkPatternRules(currentQ + 1);
        }

        // --- SAVE LOGIC ---
        document.getElementById('editor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            btn.disabled = true;

            try {
                const mockId = document.getElementById('active-mock-id').innerText;
                const qNum = parseInt(document.getElementById('q-number').value);
                const type = document.getElementById('q-type').value;
                
                let data = {
                    mockId: mockId,
                    qNumber: qNum,
                    type: type,
                    section: document.getElementById('section').value,
                    text: document.getElementById('q-text').value,
                    solution: document.getElementById('solution-text').value,
                    timestamp: new Date()
                };

                if(type === 'SA') {
                    data.correct = document.getElementById('sa-val').value;
                    if(!data.correct) throw new Error("Enter correct numeric answer");
                    data.options = [];
                } else {
                    data.options = [
                        document.getElementById('opt-a').value,
                        document.getElementById('opt-b').value,
                        document.getElementById('opt-c').value,
                        document.getElementById('opt-d').value
                    ];
                    const selected = document.querySelector('input[name="correct"]:checked');
                    if(!selected) throw new Error("Select correct option");
                    const map = {'A':0, 'B':1, 'C':2, 'D':3};
                    data.correct = data.options[map[selected.value]];
                    if(type === 'RC') data.passage = document.getElementById('passage-text').value;
                }

                const docId = document.getElementById('doc-id').value;
                if(docId) {
                    await db.collection('questions').doc(docId).update(data);
                } else {
                    await db.collection('questions').add(data);
                }

                alert("Saved!");
                loadQuestionsList(); 
                prepareNewEntry();

            } catch (err) { alert(err.message); } 
            finally { btn.disabled = false; }
        });
    </script>
</body>
</html>